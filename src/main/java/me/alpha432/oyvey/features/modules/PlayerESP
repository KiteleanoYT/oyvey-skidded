package com.example.client;

import com.mojang.blaze3d.systems.RenderSystem;
import net.fabricmc.fabric.api.client.rendering.v1.WorldRenderEvents;
import net.minecraft.client.MinecraftClient;
import net.minecraft.client.render.*;
import net.minecraft.client.util.math.MatrixStack;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.util.math.Box;

public class ESP {

    public static void init() {
        WorldRenderEvents.AFTER_ENTITIES.register(context -> {
            MinecraftClient mc = MinecraftClient.getInstance();

            if (mc.world == null || mc.player == null) return;

            MatrixStack matrices = context.matrixStack();
            Camera camera = context.camera();

            Vec3d camPos = camera.getPos();

            RenderSystem.disableDepthTest();
            RenderSystem.setShader(GameRenderer::getPositionColorProgram);

            BufferBuilder buffer = Tessellator.getInstance().getBuffer();

            for (PlayerEntity player : mc.world.getPlayers()) {

                if (player == mc.player) continue;

                Box box = player.getBoundingBox()
                        .offset(-camPos.x, -camPos.y, -camPos.z);

                drawBox(matrices, buffer, box, 1f, 0f, 0f, 1f);
            }

            RenderSystem.enableDepthTest();
        });
    }

    private static void drawBox(MatrixStack matrices, BufferBuilder buffer, Box box,
                                float r, float g, float b, float a) {

        Matrix4f matrix = matrices.peek().getPositionMatrix();

        buffer.begin(VertexFormat.DrawMode.LINES, VertexFormats.POSITION_COLOR);

        // col»õuri box
        buffer.vertex(matrix, (float)box.minX, (float)box.minY, (float)box.minZ).color(r,g,b,a).next();
        buffer.vertex(matrix, (float)box.maxX, (float)box.minY, (float)box.minZ).color(r,g,b,a).next();

        buffer.vertex(matrix, (float)box.maxX, (float)box.minY, (float)box.minZ).color(r,g,b,a).next();
        buffer.vertex(matrix, (float)box.maxX, (float)box.maxY, (float)box.minZ).color(r,g,b,a).next();

        buffer.vertex(matrix, (float)box.maxX, (float)box.maxY, (float)box.minZ).color(r,g,b,a).next();
        buffer.vertex(matrix, (float)box.minX, (float)box.maxY, (float)box.minZ).color(r,g,b,a).next();

        buffer.vertex(matrix, (float)box.minX, (float)box.maxY, (float)box.minZ).color(r,g,b,a).next();
        buffer.vertex(matrix, (float)box.minX, (float)box.minY, (float)box.minZ).color(r,g,b,a).next();

        Tessellator.getInstance().draw();
    }
}
